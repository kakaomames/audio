name: 指紋を用いた高度なオーディオ資産管理

on:
  push:
    paths:
      - 'minecraft/**'
      - 'ポケモンクエスト/**'
      - 'アナザーエデン/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Update Audio Assets
        run: |
          python - <<EOF
          import os
          import json
          import uuid
          import hashlib

          def get_hash(path):
              print(f"Calculating hash for: {path}")
              with open(path, 'rb') as f:
                  h = hashlib.sha1(f.read()).hexdigest()
                  print(f"Hash: {h}")
                  return h

          AUDIO_JSON = 'audio.json'
          MANIFEST_JSON = 'audiomanifest.json'
          TARGET_DIRS = ['minecraft', 'ポケモンクエスト', 'アナザーエデン']

          # 1. 既存データの読み込み
          old_audio_data = {}
          if os.path.exists(AUDIO_JSON):
              with open(AUDIO_JSON, 'r', encoding='utf-8') as f:
                  old_audio_data = json.load(f)
          print(f"old_audio_data size: {len(old_audio_data)}")
          
          manifest_data = {}
          if os.path.exists(MANIFEST_JSON):
              with open(MANIFEST_JSON, 'r', encoding='utf-8') as f:
                  manifest_data = json.load(f)

          # パスからUUIDを逆引きするための辞書
          path_to_uuid = {info['path']: k for k, info in old_audio_data.items() if isinstance(info, dict) and 'path' in info}

          new_audio_data = {}
          
          # 2. ファイルスキャン
          for target in TARGET_DIRS:
              if not os.path.exists(target):
                  print(f"Directory not found: {target}")
                  continue
              for root, dirs, files in os.walk(target):
                  for file in files:
                      if file.startswith('.'): continue
                      
                      local_path = os.path.join(root, file)
                      # ここを修正：バックスラッシュをスラッシュに置換
                      full_url_path = f"/audio/{local_path}".replace('\\', '/')
                      print(f"full_url_path: {full_url_path}")
                      
                      file_hash = get_hash(local_path)
                      target_uuid = None
                      
                      # A. 同じパスが既にあるか？
                      if full_url_path in path_to_uuid:
                          target_uuid = path_to_uuid[full_url_path]
                          print(f"Found existing UUID by path: {target_uuid}")
                      else:
                          # B. パスは違うけど、中身（ハッシュ）が同じやつがいるか？
                          for uid, info in old_audio_data.items():
                              if isinstance(info, dict) and info.get('hash') == file_hash:
                                  old_uid = uid
                                  new_gen_uuid = f"uuid_{uuid.uuid4().hex[:8]}"
                                  manifest_data[old_uid] = new_gen_uuid
                                  target_uuid = new_gen_uuid
                                  print(f"Rename detected! {info['path']} -> {full_url_path} (New ID: {target_uuid})")
                                  break
                      
                      # C. 完全な新規ファイル
                      if not target_uuid:
                          target_uuid = f"uuid_{uuid.uuid4().hex[:8]}"
                          if "null" not in manifest_data: manifest_data["null"] = []
                          manifest_data["null"].append(target_uuid)
                          print(f"Completely new file! Assigned UUID: {target_uuid}")
                      
                      new_audio_data[target_uuid] = {
                          "path": full_url_path,
                          "hash": file_hash,
                          "name": os.path.splitext(file)[0]
                      }

          # 4. 保存
          with open(AUDIO_JSON, 'w', encoding='utf-8') as f:
              json.dump(new_audio_data, f, ensure_ascii=False, indent=2)
          with open(MANIFEST_JSON, 'w', encoding='utf-8') as f:
              json.dump(manifest_data, f, ensure_ascii=False, indent=2)

          print("Successfully updated audio.json and audiomanifest.json")
          EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add audio.json audiomanifest.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "fix: update audio asset tracking [skip ci]" && git push)
