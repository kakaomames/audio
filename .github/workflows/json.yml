name: éŸ³å£°è³‡ç”£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆè‡ªå‹•JSONæ›´æ–°ï¼‰ğŸ“

on:
  push:
    paths:
      - 'minecraft/**'
      - 'ãƒã‚±ãƒ¢ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆ/**'
      - 'ã‚¢ãƒŠã‚¶ãƒ¼ã‚¨ãƒ‡ãƒ³/**'

jobs:
  ã‚¢ã‚»ãƒƒãƒˆæ›´æ–°ã‚¸ãƒ§ãƒ–:
    name: ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªJSONã¨ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®è‡ªå‹•ç”Ÿæˆ
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ã‚­ãƒ£ãƒ³ã¨JSONç”Ÿæˆ
        run: |
          python - <<'EOF'
          import os
          import json
          import uuid
          import hashlib

          def get_hash(path):
              print(f"ãƒãƒƒã‚·ãƒ¥è¨ˆç®—ä¸­: {path}")
              with open(path, 'rb') as f:
                  h = hashlib.sha1(f.read()).hexdigest()
                  print(f"è¨ˆç®—çµæœ (h): {h}")
                  return h

          AUDIO_JSON = 'audio.json'
          MANIFEST_JSON = 'audiomanifest.json'
          TARGET_DIRS = ['minecraft', 'ãƒã‚±ãƒ¢ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆ', 'ã‚¢ãƒŠã‚¶ãƒ¼ã‚¨ãƒ‡ãƒ³']

          # 1. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
          old_audio_data = {}
          if os.path.exists(AUDIO_JSON):
              with open(AUDIO_JSON, 'r', encoding='utf-8') as f:
                  old_audio_data = json.load(f)
          print(f"æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿æ•° (old_audio_data size): {len(old_audio_data)}")
          
          manifest_data = {}
          if os.path.exists(MANIFEST_JSON):
              with open(MANIFEST_JSON, 'r', encoding='utf-8') as f:
                  manifest_data = json.load(f)

          # ãƒ‘ã‚¹ã‹ã‚‰UUIDã‚’é€†å¼•ãã™ã‚‹ãŸã‚ã®è¾æ›¸
          path_to_uuid = {info['path']: k for k, info in old_audio_data.items() if isinstance(info, dict) and 'path' in info}

          new_audio_data = {}
          
          # 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³
          for target in TARGET_DIRS:
              if not os.path.exists(target):
                  print(f"ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {target}")
                  continue
              for root, dirs, files in os.walk(target):
                  for file in files:
                      if file.startswith('.'): continue
                      
                      local_path = os.path.join(root, file)
                      full_url_path = f"/audio/{local_path}".replace(os.sep, '/')
                      print(f"ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã®ãƒ‘ã‚¹: {full_url_path}")
                      
                      file_hash = get_hash(local_path)
                      target_uuid = None
                      
                      # A. æ—¢å­˜ãƒ‘ã‚¹ã®ãƒã‚§ãƒƒã‚¯
                      if full_url_path in path_to_uuid:
                          target_uuid = path_to_uuid[full_url_path]
                          print(f"æ—¢å­˜ã®UUIDã‚’ä½¿ç”¨ (target_uuid): {target_uuid}")
                      else:
                          # B. ãƒªãƒãƒ¼ãƒ æ¤œçŸ¥ï¼ˆãƒãƒƒã‚·ãƒ¥ä¸€è‡´ï¼‰
                          for uid, info in old_audio_data.items():
                              if isinstance(info, dict) and info.get('hash') == file_hash:
                                  old_uid = uid
                                  new_gen_uuid = f"uuid_{uuid.uuid4().hex[:8]}"
                                  manifest_data[old_uid] = new_gen_uuid
                                  target_uuid = new_gen_uuid
                                  print(f"ãƒªãƒãƒ¼ãƒ ã‚’æ¤œçŸ¥ï¼ æ–°è¦IDç™ºè¡Œ: {target_uuid}")
                                  break
                      
                      # C. å®Œå…¨æ–°è¦
                      if not target_uuid:
                          target_uuid = f"uuid_{uuid.uuid4().hex[:8]}"
                          if "null" not in manifest_data: manifest_data["null"] = []
                          manifest_data["null"].append(target_uuid)
                          print(f"å®Œå…¨æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œçŸ¥ (target_uuid): {target_uuid}")
                      
                      new_audio_data[target_uuid] = {
                          "path": full_url_path,
                          "hash": file_hash,
                          "name": os.path.splitext(file)[0]
                      }

          # ä¿å­˜
          with open(AUDIO_JSON, 'w', encoding='utf-8') as f:
              json.dump(new_audio_data, f, ensure_ascii=False, indent=2)
          with open(MANIFEST_JSON, 'w', encoding='utf-8') as f:
              json.dump(manifest_data, f, ensure_ascii=False, indent=2)

          print("audio.json ã¨ audiomanifest.json ã®æ›´æ–°ãŒå®Œäº†ã—ãŸãï¼")
          EOF

      - name: å¤‰æ›´ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ã¦Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add audio.json audiomanifest.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "update: éŸ³å£°ã‚¢ã‚»ãƒƒãƒˆç®¡ç†ã®æ›´æ–° [skip ci]" && git push)
